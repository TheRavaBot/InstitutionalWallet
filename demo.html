<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lost Found Items</title>
  <link rel="stylesheet" href="styles.css">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
  <div id="sidebar-container"></div> 
  <span class="menu-btn" onclick="toggleSidebar()" aria-label="Open Menu">☰</span>
  <header class="header">
    <h1 class="headerc">University Of Ilorin Digital Wallet</h1>
  </header>

  <section class="page-section dashboard">
    <div class="icon-spot">
      <img src="icon.png" alt="Dashboard Icon" class="icon">
    </div>
    <h2>Lost & Found Items</h2>

    <input type="text" id="searchInput" placeholder="Search by Name, Email, Matric, or Description..." />
    <table class="history-table" id="lostItemsTable">
      <thead>
        <tr>
          <th>Founder's Name</th>
          <th>Item Name</th>
          <th>Item Description</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="lostItemsBody"></tbody>
    </table>
  </section>

  <!-- Image Modal -->
  <div id="imageModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeImageModal()">&times;</span>
      <img id="modalImage" src="" alt="Item Image" style="width:100%; border-radius:10px;">
    </div>
  </div>

  <!-- Claim Confirmation Modal -->
  <div id="claimModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeClaimModal()">&times;</span>
      <p id="claimText">Make payment of ₦1000 to the founder?</p>
      <button onclick="confirmClaim()">Yes</button>
      <button onclick="closeClaimModal()">No</button>
    </div>
  </div>

  <script>
    fetch('sidebar.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('sidebar-container').innerHTML = data;
        const script = document.createElement("script");
        script.src = "script.js";
        document.body.appendChild(script);
      })
      .catch(error => console.error('Error loading sidebar:', error));

    const firebaseConfig = {
      apiKey: "AIzaSyAmhaIhOWWlPYceSdtJScVIIuZP0Rb71hM",
      authDomain: "project-iot-51262.firebaseapp.com",
      databaseURL: "https://project-iot-51262-default-rtdb.firebaseio.com",
      projectId: "project-iot-51262",
      storageBucket: "project-iot-51262.appspot.com",
      messagingSenderId: "785303672386",
      appId: "1:785303672386:web:8fb1aaac3c34e72e87bfdb"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const searchInput = document.getElementById("searchInput");
    const lostItemsBody = document.getElementById("lostItemsBody");
    const modalImage = document.getElementById("modalImage");
    const imageModal = document.getElementById("imageModal");

    const claimModal = document.getElementById("claimModal");
    const claimText = document.getElementById("claimText");

    let lostItems = [];
    let selectedItem = null;

    // const currentUserMatric = "user123"; // Replace with actual logged-in user's matric number
    const currentUserMatric = localStorage.getItem("matric");

    // Load all found items
    db.ref("unilorin-ict/founditems").once("value", snapshot => {
      snapshot.forEach(child => {
        const item = child.val();
        item.id = child.key;
        lostItems.push(item);
      });
      displayLostItems(lostItems);
    });

    function displayLostItems(items) {
      lostItemsBody.innerHTML = "";
      items.forEach(item => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.founder_name || "-"}</td>
          <td>${item.item_name || "-"}</td>
          <td>${item.item_description || "-"}</td>
          <td>${item.status || "-"}</td>
          <td>
            <button onclick="viewImage('${item.image_url}')">View Image</button> ||
            <button onclick="claimitem('${item.id}')">Claim Item</button>
          </td>
        `;
        lostItemsBody.appendChild(row);
      });
    }

    searchInput.addEventListener("input", () => {
      const query = searchInput.value.toLowerCase();
      const filtered = lostItems.filter(item =>
        item.founder_name?.toLowerCase().includes(query) ||
        item.item_description?.toLowerCase().includes(query) ||
        item.item_name?.toLowerCase().includes(query)
      );
      displayLostItems(filtered);
    });

    function viewImage(url) {
      modalImage.src = url;
      imageModal.style.display = "block";
    }

    function closeImageModal() {
      imageModal.style.display = "none";
    }

    function claimitem(itemId) {
      selectedItem = lostItems.find(i => i.id === itemId);
      if (!selectedItem) return;
      claimText.textContent = `Make payment of ₦1000 to the founder (${selectedItem.founder_name})?`;
      claimModal.style.display = "block";
    }

    function closeClaimModal() {
      claimModal.style.display = "none";
      selectedItem = null;
    }

    function confirmClaim() {
      if (!selectedItem) return;

      const itemRef = db.ref("unilorin-ict/founditems/" + selectedItem.id);

      const founderMatric = selectedItem.founder_matric;
      const userRef = db.ref("unilorin-ict/users/" + currentUserMatric);
      const founderRef = db.ref("unilorin-ict/users/" + founderMatric);

      Promise.all([userRef.once("value"), founderRef.once("value")]).then(([userSnap, founderSnap]) => {
        const user = userSnap.val();
        const founder = founderSnap.val();

        if (!user || user.balance < 1000) {
          alert("Insufficient balance.");
          closeClaimModal();
          return;
        }

        const updates = {};
        updates[`unilorin-ict/users/${currentUserMatric}/balance`] = user.balance - 1000;

        if (founder) {
          updates[`unilorin-ict/users/${founderMatric}/balance`] = (founder.balance || 0) + 1000;
        }

        updates[`unilorin-ict/founditems/${selectedItem.id}/status`] = "claimed";

        db.ref().update(updates).then(() => {
          alert("Item successfully claimed!");
          selectedItem.status = "claimed";
          displayLostItems(lostItems);
          closeClaimModal();
        }).catch(err => {
          console.error("Error processing claim:", err);
          alert("Error processing claim.");
          closeClaimModal();
        });
      });
    }
  </script>

  <style>
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background: white;
      margin: 15% auto;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }

    .modal-content button {
      margin: 10px;
    }
  </style>
</body>
</html>
